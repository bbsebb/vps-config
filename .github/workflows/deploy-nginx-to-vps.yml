name: Deploy NGINX to VPS

on:
  push:
    branches:
      - vps  # or master, depending on your default branch name
    paths:
      - 'nginx/**'
      - '.github/workflows/deploy-nginx-to-vps.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
          
      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ vars.VPS_HOST }} >> ~/.ssh/known_hosts
          
      - name: Deploy configuration to VPS
        run: |
          echo "Deploying configuration to VPS..."
          
          # Create a temporary directory structure on the VPS
          ssh ${{ vars.VPS_USERNAME }}@${{ vars.VPS_HOST }} "mkdir -p ~/temp_nginx_config/sites"
          
          # Copy Nginx configurations to the temporary directory
          scp nginx/nginx.conf ${{ vars.VPS_USERNAME }}@${{ vars.VPS_HOST }}:~/temp_nginx_config/nginx.conf
          scp -r nginx/sites-available/* ${{ vars.VPS_USERNAME }}@${{ vars.VPS_HOST }}:~/temp_nginx_config/sites/
          
          # Use sudo to create directories and move files to their final locations
          ssh ${{ vars.VPS_USERNAME }}@${{ vars.VPS_HOST }} "echo '${{ secrets.VPS_USER_PASSWORD }}' | sudo -S mkdir -p /etc/nginx/sites-available /etc/nginx/sites-enabled"
          ssh ${{ vars.VPS_USERNAME }}@${{ vars.VPS_HOST }} "echo '${{ secrets.VPS_USER_PASSWORD }}' | sudo -S cp ~/temp_nginx_config/nginx.conf /etc/nginx/"
          ssh ${{ vars.VPS_USERNAME }}@${{ vars.VPS_HOST }} "echo '${{ secrets.VPS_USER_PASSWORD }}' | sudo -S cp ~/temp_nginx_config/sites/* /etc/nginx/sites-available/"
          
          # Create symbolic links for enabled sites (if they don't exist)
          ssh ${{ vars.VPS_USERNAME }}@${{ vars.VPS_HOST }} "for site in /etc/nginx/sites-available/*; do \
            site_name=\$(basename \$site); \
            if [ ! -L /etc/nginx/sites-enabled/\$site_name ]; then \
              echo '${{ secrets.VPS_USER_PASSWORD }}' | sudo -S ln -sf /etc/nginx/sites-available/\$site_name /etc/nginx/sites-enabled/\$site_name; \
            fi \
          done"
          
          # Clean up temporary directory
          ssh ${{ vars.VPS_USERNAME }}@${{ vars.VPS_HOST }} "rm -rf ~/temp_nginx_config"
          
      - name: Test Nginx configuration and reload
        run: |
          echo "Testing Nginx configuration..."
          ssh ${{ vars.VPS_USERNAME }}@${{ vars.VPS_HOST }} "echo '${{ secrets.VPS_USER_PASSWORD }}' | sudo -S nginx -t && echo '${{ secrets.VPS_USER_PASSWORD }}' | sudo -S systemctl reload nginx"
          echo "Configuration deployed and Nginx reloaded successfully!"